# RAG Streamingプロジェクト概要

## 1. プロジェクト概要
プロジェクト名: RAG Streaming
目的: PDFドキュメントの目次（TOC）をベクトル化し、ユーザーの質問に基づいて関連する目次とマニュアルの内容を検索・表示し、OpenAIに回答させるRAGシステム。ユーザーフレンドリーなインターフェースと効率的な検索機能を提供する。

## 2. アーキテクチャ
- Frontend: ユーザーインターフェース（FastAPI + Jinja2テンプレート）
- Backend: 検索ロジックと類似度計算を行い、WebSocketを通じて検索結果のリストを返却する（FastAPI）
- pgvector_toc: ベクトルデータベース（PostgreSQL + pgvector）
- s3_db: PDFファイルストレージ（FastAPI）

注: 全てのサービスでFastAPIを採用し、一貫性と高パフォーマンスを実現。

## 3. docker-compose.yml
添付ファイル参照。主な特徴：
- 全サービスでUvicornを使用し、開発環境では`--reload`フラグを有効化
- ポートマッピングを`127.0.0.1`にバインドしてセキュリティを強化
- 環境変数を活用してサービス間の接続情報を管理

## 4. Dockerfiles
添付ファイル参照。各サービスに最適化されたDockerfile構成。

## 5. 動作仕様

a. フロントエンド (frontend):
- FastAPIとJinja2テンプレートを使用してユーザーインターフェースを提供
- WebSocketを使用してbackendと通信
- 検索結果を動的に表示
- PDFリンクを生成し、クリック時にs3_dbからPDFを取得し、Streamingで表示する
- ダークモード/ライトモードの切り替え機能を提供

b. バックエンド (backend):
- WebSocketを通じてfrontendからの検索クエリを受け取る
- OpenAI APIを使用してクエリをベクトル化
- pgvector_tocデータベースで類似度検索を実行
- 検索結果をWebSocketを通じてフロントエンドに返す

c. ベクトルデータベース (pgvector_toc):
- PDFの目次（TOC）データとそのベクトル表現を保存
- 高速な類似度検索を可能にする

d. PDFストレージ (s3_db):
- PDFファイルを保存
- frontendでStreaming表示する際にここからPDFを取得する
- 特定のページのみを抽出して返す機能を提供

## 6. 主要な機能
1. インタラクティブな検索インターフェース:
   - ユーザーが検索クエリを入力できるテキストボックス
   - 検索結果の数を指定できる数値入力フィールド（デフォルト: 3、範囲: 1-10）
   - 検索ボタンで検索を実行

2. リアルタイム検索結果表示:
   - WebSocketを使用した非同期通信による高速な結果表示
   - 検索中の「Searching...」表示

3. 検索結果の詳細表示:
   - 各結果に対して、PDFファイル名とページ番号を含むリンクを生成
   - TOC（目次）情報の表示
   - 類似度（Distance）の表示

4. PDFビューア機能:
   - 検索結果のリンクをクリックすると、該当ページのPDFをストリーミング表示
   - 特定のページのみを表示する機能

5. テーマ切り替え機能:
   - ダークモードとライトモードの切り替えが可能
   - ユーザーの設定をローカルストレージに保存し、次回訪問時に反映

6. レスポンシブデザイン:
   - さまざまな画面サイズに対応したレイアウト

7. エラーハンドリング:
   - 検索エラーや通信エラーの適切な処理と表示

## 7. 環境変数
- OPENAI_API_KEY: OpenAI APIキー
- S3_DB_URL: PDFストレージサービスのURL
- POSTGRES_URL: PostgreSQLデータベースの接続URL
- POSTGRES_DB: データベース名
- POSTGRES_USER: データベースユーザー名
- POSTGRES_PASSWORD: データベースパスワード
- POSTGRES_HOST: データベースホスト
- POSTGRES_PORT: データベースポート

注: セキュリティ向上のため、機密情報は環境変数として管理。

## 8. 起動方法
開発環境:
```
docker compose up --build
```

本番環境:
```
docker compose -f docker-compose.prod.yml up --build
```
注: 本番環境用の`docker-compose.prod.yml`ファイルは別途作成が必要。

## 9. アクセス方法
- フロントエンド: http://localhost:8000
- バックエンドAPI: http://localhost:8001
- PDFストレージ: http://localhost:9000

## 10. 今後の改善点
1. API ドキュメンテーション: FastAPIの自動生成されるSwagger UIを活用し、さらに詳細なAPIドキュメントを追加
2. ログ管理: 構造化ログを導入し、集中ログ管理システムと連携
3. 設定管理: AWS Systems Manager Parameter Storeなどを使用した本番環境での動的設定管理
4. テスト: ユニットテスト、統合テスト、エンドツーエンドテストの追加
5. コードコメント: 複雑なロジックに対する詳細なインラインコメントの追加
6. エラーハンドリング: グローバルな例外ハンドラーの実装と、ユーザーフレンドリーなエラーメッセージの提供
7. 入力バリデーション: Pydanticモデルを活用した厳密な入力検証の実装
8. パフォーマンス最適化: キャッシュメカニズムの導入と非同期処理の最適化
9. スケーラビリティ: コンテナオーケストレーションツール（例：Kubernetes）の導入検討
10. モニタリング: Prometheus、Grafana等を使用したシステムの健全性とパフォーマンスのモニタリング導入
11. セキュリティ強化: TLS/SSL導入、定期的なセキュリティ監査の実施
12. CI/CD: 自動テスト、ビルド、デプロイのパイプライン構築
13. ユーザー認証: 管理者用の設定変更インターフェースへのアクセス制御
14. 多言語サポート: 国際化（i18n）の実装
15. アクセシビリティ: WAI-ARIAガイドラインに基づくアクセシビリティの向上

注: FastAPIの採用により、API文書化、バリデーション、非同期処理などの実装が容易になりました。
